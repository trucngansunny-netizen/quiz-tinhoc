<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI-TIN ‚Äî Ch·∫•m b√†i Tin h·ªçc</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Arial, sans-serif;
      margin: 0; padding: 0;
      background: url("/static/bg_default.jpg") no-repeat center center / cover;
      color: #1b2935;
    }
    .overlay { background: rgba(255,255,255,0.88); max-width: 980px; margin: 30px auto; border-radius: 12px; padding: 18px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); }
    h1 { margin: 6px 0 12px 0; color:#0b66c3; font-size:24px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    label { font-weight:600; display:block; margin-bottom:6px; }
    select, input[type=file], button { padding:10px; border-radius:8px; border:1px solid #cbd5e1; background:white; }
    .btn { background:#0b76ef; color:white; border:none; cursor:pointer; }
    .muted { color:#475569; font-size:14px; }
    .result { background:#f8fafc; border-left:4px solid #0b76ef; padding:12px; margin-top:12px; border-radius:8px; }
    .success { color: #0b8537; font-weight:700; }
    .error { color: #c53030; font-weight:700; }
    .footer { text-align:right; margin-top:12px; color:#64748b; font-size:13px; }
    .visitbox { position: fixed; right: 12px; bottom: 12px; background: rgba(255,255,255,0.9); padding:8px 10px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.08); font-size:13px; color:#334155; }
    .logo { height:54px; float:left; margin-right:12px; }
  </style>
</head>
<body>
  <div class="overlay">
    <div style="display:flex; align-items:center; gap:12px;">
      <img src="/static/logo_tranquoctoan.png" alt="logo" class="logo" onerror="this.style.display='none'">
      <div>
        <h1>üß† AI-TIN ‚Äî H·ªá th·ªëng ch·∫•m b√†i Tin h·ªçc</h1>
        <div class="muted">Ch·ªçn Kh·ªëi ‚Üí Ch·ªçn L·ªõp ‚Üí Ch·ªçn M√¥n ‚Üí N·ªôp t·ªáp ƒë·ªÉ ch·∫•m</div>
      </div>
    </div>

    <hr style="margin:12px 0; border:none; border-top:1px solid #e6eef8;">

    {% if message %}
      <div class="result error">{{ message }}</div>
    {% endif %}

    <form method="post" enctype="multipart/form-data">
      <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
        <div style="min-width:160px;">
          <label>Ch·ªçn kh·ªëi</label>
          <select name="grade" id="grade" onchange="onGradeChange()">
            <option value="">-- Ch·ªçn kh·ªëi --</option>
            <option value="3">Kh·ªëi 3</option>
            <option value="4">Kh·ªëi 4</option>
            <option value="5">Kh·ªëi 5</option>
          </select>
        </div>

        <div style="min-width:160px;">
          <label>Ch·ªçn l·ªõp</label>
          <select name="class" id="class">
            <option value="">-- Ch·ªçn l·ªõp --</option>
            {% for cls in classes %}
              <option value="{{ cls }}">{{ cls }}</option>
            {% endfor %}
          </select>
        </div>

        <div style="min-width:200px;">
          <label>Ch·ªçn m√¥n</label>
          <select name="subject" id="subject">
            <option value="">-- Ch·ªçn m√¥n --</option>
            <option value="Word">Word</option>
            <option value="PowerPoint">PowerPoint</option>
            <option value="Scratch">Scratch</option>
          </select>
        </div>

        <div style="flex:1; min-width:260px;">
          <label>Ch·ªçn t·ªáp (docx / pptx / sb3)</label>
          <input type="file" name="file" accept=".docx,.pptx,.sb3,.zip" required>
        </div>

        <div style="align-self:flex-end;">
          <button type="submit" class="btn">üì§ N·ªôp & Ch·∫•m</button>
        </div>
      </div>
    </form>

    {% if result %}
      <div class="result" style="margin-top:14px;">
        <div><span class="success">‚úÖ B√†i ƒë√£ ch·∫•m xong!</span></div>
        <div style="margin-top:8px;"><strong>H·ªç t√™n:</strong> {{ result.student }} &nbsp;&nbsp; <strong>L·ªõp:</strong> {{ result.class }} &nbsp;&nbsp; <strong>M√¥n:</strong> {{ result.subject }}</div>
        <div style="margin-top:6px;"><strong>ƒêi·ªÉm:</strong> {{ result.total }} / 10 &nbsp;&nbsp; <strong>Nh·∫≠n x√©t:</strong> {{ result.remark }}</div>

        <hr style="margin:8px 0; border:none; border-top:1px solid #e6eef8;">
        <div style="font-size:14px;"><strong>Chi ti·∫øt ti√™u ch√≠:</strong></div>
        <ul>
          {% for line in result.notes %}
            <li>{{ line }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <div class="footer">¬© AI-TIN ‚Ä¢ Th·ªëng k√™ l∆∞·ª£t truy c·∫≠p: {{ visit_count }}</div>
  </div>

  <div class="visitbox">L∆∞·ª£t truy c·∫≠p: {{ visit_count }}</div>

  <script>
    // ·∫®n/hi·ªán m√¥n theo kh·ªëi (client-side)
    const avail = {{ avail_by_grade|tojson }};
    function onGradeChange(){
      const g = document.getElementById('grade').value;
      const subj = document.getElementById('subject');
      // reset
      for (let i=0; i<subj.options.length; i++){
        subj.options[i].style.display = 'block';
        subj.options[i].disabled = false;
      }
      if (!g) return;
      // hide not allowed
      const allowed = avail[g] || [];
      for (let i=0; i<subj.options.length; i++){
        const val = subj.options[i].value;
        if (val && !allowed.includes(val)){
          subj.options[i].style.display = 'none';
          subj.options[i].disabled = true;
        }
      }
      // auto-select first allowed
      for (let i=0; i<subj.options.length; i++){
        if (!subj.options[i].disabled && subj.options[i].value){
          subj.selectedIndex = i; break;
        }
      }
      // change background image according to grade
      let bg = "/static/bg_default.jpg";
      if (g === "3") bg = "/static/bg_3.jpg";
      if (g === "4") bg = "/static/bg_4.jpg";
      if (g === "5") bg = "/static/bg_5.jpg";
      document.body.style.background = "url('"+bg+"') no-repeat center center / cover";
    }
  </script>
</body>
</html>
